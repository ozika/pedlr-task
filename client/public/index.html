<!DOCTYPE html>
<html>

<head>
  <title>pedlr-task</title>

  <!-- Source jspsych plugins -->
  <script src="jspsych-6.2.0/jspsych.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-button-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-slider-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-canvas-slider-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-call-function.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-external-html.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-survey-multi-choice.js"></script>

  <!-- Source package to get browser of participant -->
  <script src="https://unpkg.com/bowser@2.7.0/es5.js"></script>

  <!-- Source .json including all designs -->
  <script type="text/javascript" src="designs/designs.js" type="application/json"></script>

  <!-- Source own functions for different trials/parts of task -->
  <script src="take_a_break.js"></script>
  <script src="fixation.js"></script>
  <script src="feedback.js"></script>
  <script src="free.js"></script>
  <script src="forced.js"></script>
  <script src="estimation.js"></script>
  <script src="if_nodes.js"></script>
  <script src="training.js"></script>

  <!-- Source attion checks -->
  <script src="attention_checks.js"></script>

  <!-- Function to display study info and consent (including check of given consent)-->
  <script src="info_and_consent.js"></script>

  <!-- Source JQuery for data saving -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

  <!-- Use CSS style sheet of jspsych (gives e.g. font, font size, ... of displayed trials) -->
  <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<!-- Color of background and font for experiment -->
<body style="background-color:#000000; color:white">
</body>

<script>

//preload stimuli files
// Get folder contents of stimuli pictures
var stimuli = ['stimuli/a1.png',
               'stimuli/a1.png',
               'stimuli/a1_forced.png',
               'stimuli/a2.png',
               'stimuli/a2_forced.png',
               'stimuli/a3.png',
               'stimuli/a3_forced.png',
               'stimuli/s1.png',
               'stimuli/s1_forced.png',
               'stimuli/s2.png',
               'stimuli/s2_forced.png',
               'stimuli/s3.png',
               'stimuli/s3_forced.png',
               'stimuli/s4.png',
               'stimuli/s4_forced.png',
               'stimuli/s5.png',
               'stimuli/s5_forced.png',
               'stimuli/s6.png',
               'stimuli/s6_forced.png',
               'stimuli/fixation.png'
             ]

// Create list of all designs (separate for each run)
var all_designs_r1 = [
  design_01_run_1, design_02_run_1, design_03_run_1, design_04_run_1,
  design_05_run_1, design_06_run_1, design_07_run_1, design_08_run_1,
  design_09_run_1, design_10_run_1, design_11_run_1, design_12_run_1,
  design_13_run_1, design_14_run_1, design_15_run_1, design_16_run_1,
  design_17_run_1, design_18_run_1, design_19_run_1, design_20_run_1
]

var all_designs_r2 = [
  design_01_run_2, design_02_run_2, design_03_run_2, design_04_run_2,
  design_05_run_2, design_06_run_2, design_07_run_2, design_08_run_2,
  design_09_run_2, design_10_run_2, design_11_run_2, design_12_run_2,
  design_13_run_2, design_14_run_2, design_15_run_2, design_16_run_2,
  design_17_run_2, design_18_run_2, design_19_run_2, design_20_run_2
]

// Get names of designs to save as variable
var names_designs_r1 = [
  'design_01_run_1', 'design_02_run_1', 'design_03_run_1', 'design_04_run_1',
  'design_05_run_1', 'design_06_run_1', 'design_07_run_1', 'design_08_run_1',
  'design_09_run_1', 'design_10_run_1', 'design_11_run_1', 'design_12_run_1',
  'design_13_run_1', 'design_14_run_1', 'design_15_run_1', 'design_16_run_1',
  'design_17_run_1', 'design_18_run_1', 'design_19_run_1', 'design_20_run_1'
]
var names_designs_r2 = [
  'design_01_run_2', 'design_02_run_2', 'design_03_run_2', 'design_04_run_2',
  'design_05_run_2', 'design_06_run_2', 'design_07_run_2', 'design_08_run_2',
  'design_09_run_2', 'design_10_run_2', 'design_11_run_2', 'design_12_run_2',
  'design_13_run_2', 'design_14_run_2', 'design_15_run_2', 'design_16_run_2',
  'design_17_run_2', 'design_18_run_2', 'design_19_run_2', 'design_20_run_2'
]

// Sample design and take both runs from same design
var n_designs = all_designs_r1.length;
var sample = Math.floor(Math.random() * n_designs);
// Set designs for this participant
var design_r1 = all_designs_r1[sample]
var design_r2 = all_designs_r2[sample]
// Save names of designs
var name_design_r1 = names_designs_r1[sample]
var name_design_r2 = names_designs_r2[sample]

// Set scaling of images and margins to adjust size of experiment (in percentage)
var img_scale = 40

// Create random subject string (replace with prolific ID later)
function MakeId() {
    var result           = '';
    var characters       = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    var charactersLength = characters.length;
    for ( var i = 0; i < 7; i++ ) {
      result += characters.charAt(Math.floor(Math.random() * charactersLength));
   }
   return result;
}
var participant_id = MakeId()

// Function to get query variables from URL (e.g. prolific id); saves all query variables into vars
function getUrlVars()
{
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}
// Save prolific ID
var prolific_id = getUrlVars()["PROLIFIC_ID"]

// browser + os info
const browser = bowser.getParser(window.navigator.userAgent);
br = browser.getBrowser() //name + version
os = browser.getOS() // name + version

// Function to force fullscreen mode with check variable
var should_be_in_fullscreen = false;
var fullscreen = {
  type: 'fullscreen',
  fullscreen_mode: true,
  on_start: function () {
    should_be_in_fullscreen = true; // once this trial starts, the participant should be in fullscreen
  }
};

// Function to check
var initial_check = {
  type: 'fullscreen',
  fullscreen_mode: true,
  message: '<p>Please do NOT exit the fullscreen during the entire experiment! <br>' +
    'If you exit fullscreen mode during the experiment you will be redirected to Prolific and cannot continue with the experiment. </p>',
  on_start: function (trial) { //
    if (!(br.name == "Chrome" || br.name == 'Firefox' || 'Safari')) { //Safari only for now
      trial.message = not_supported;
      completion_code = 'BROWSER_NOTSUPPORTED';
      //location.replace("https://app.prolific.co/submissions/complete?cc="+completion_code);
    }
  },
  data: { type: 'initial_browser_check' }
};

// Add stable variables to data
jsPsych.data.addProperties({
  participant_id: participant_id,
  prolific_id: prolific_id,
  name_design_r1: name_design_r1,
  name_design_r2: name_design_r2,
  browser_name: br.name,
  browser_version: br.version,
  os_name: os.name,
  os_version: os.version,
  window_resolution: window.innerWidth + ' x ' + window.innerHeight,
  screen_resolution: screen.width + ' x ' + screen.height
});

var timeline = []

// Experiment run 1 procedure
var experiment_r1 = {
  timeline: [if_free, if_forced, if_estimation, if_break],
  // Get timeline from design
  //timeline_variables: design_r1
  // Example timeline for easy task testing (6 examples with break in between)
  timeline_variables: [
    {type: 'free', stimulus_left: 'stimuli/s2.png', stimulus_right: 'stimuli/s3.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s2_forced.png', stimulus_right: 'stimuli/s3.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s1.png'},
    {type: 'break', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'free', stimulus_left: 'stimuli/s2.png', stimulus_right: 'stimuli/s3.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s2_forced.png', stimulus_right: 'stimuli/s3.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s1.png'}
  ]
}

// Experiment run 2 procedure
var experiment_r2 = {
  timeline: [if_free, if_forced, if_estimation, if_break],
  // Get timeline from design
  //timeline_variables: design_r2
  // Example timeline for easy task testing (6 examples with break in between)
  timeline_variables: [
    {type: 'free', stimulus_left: 'stimuli/s5.png', stimulus_right: 'stimuli/s6.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s5_forced.png', stimulus_right: 'stimuli/s6.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s4.png'},
    {type: 'break', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'free', stimulus_left: 'stimuli/s5.png', stimulus_right: 'stimuli/s6.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s5_forced.png', stimulus_right: 'stimuli/s6.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s4.png'}
  ]
}

// Trial type of halftime screen (stimulus change)
var halftime = {
  timeline: [
    {
      type: 'html-keyboard-response',
      stimulus: function(){
        var html = "<p>Halftime!<br></p>"
        html += "<p>You are done with the first part of the task.</p>"
        html += "<p>You've earned yourself a short break!<br></p>"
        html += "<img src='stimuli/break.png'; style='width: " + 300/100 * img_scale+"px'>"
        html += "<p><br>We will now change the available three options which also give different amounts of points.</p>"
        html += "<p>The task works exactly the same, also for the new three options!</p>"
        html += "<p><br><br>Press <b>[ F ]</b> or <b>[ J ]</b> to continue with the task if you are ready.</p>"
        return html
      },
      choices: ['f', 'j']
    }
  ]
}

// Set default count for attempts and errorattempts (used by postData function)
var attempts = 0 , errorattempts = 0

// Function to send data and end experiment (will be called on finish)
function senddataNend(){
    var JSDATA = jsPsych.data.get().json()
    const body = {partial: false, data: JSDATA} //, structure according to ARC
    //postData(JSON.stringify(body))
    postData(body)
  }

// Function to update URL send back to prolific (with completion code in URL)
function SendToProlific(){
    location.replace("https://app.prolific.co/submissions/complete?cc="+completion_code);} // cant press back

// Function to wait on arc server response
function wait(ms){
    var start = new Date().getTime();
    var end = start;
    while(end < start + ms) {end = new Date().getTime(); }
 }

// Function to update URL send back to prolific (with completion code in URL)
var postData = function(data){
   $.ajax({
       async: false, // should still work, see https://stackoverflow.com/questions/11448011/jquery-ajax-methods-async-option-deprecated-what-now
       url: "https://arc-vlab.mpib-berlin.mpg.de/pedlr-task/submit",
       type: 'post',
       headers: {
           'Access-Control-Allow-Origin': '*' // not sure if this is needed
       },
       data : data,
       processData: false,
       contentType: "application/json; charset=utf-8",
       dataType: 'JSON',
       success: function (output) {
           // whatever the data try 3 times
           attempts=attempts+1
           if (output.code==0){SendToProlific(); return} // if all good, sending to prolific and done. return is in case prolific is off
           wait(2000) // wait 3 secodns
           // if didnt sent to prolific so the data was sent but other message from ARC than 0 - then try to send the data again up to 3 times
           if (attempts<3){postData(data)} // will not work after attempt 3.
           // then we try to send the error message itseld for 4th time attempt only
           if (attempts<4){postData(JSON.stringify(output))}
           // if it got here that means it tries 3 times to ARC, got non 0 code, and then sent the error to ARC and was succsfull
           SendToProlific();
       },// end success
       error: function (error) { // if the sent was not successfull, i.e. not even an ARC code
           wait(2000) // wait 3 secodns
           errorattempts=errorattempts+1
           if (errorattempts<3){postData(data)} //  will not work after attempt 3
           // then we try to send the error message itsels.
           if (errorattempts<4){postData(JSON.stringify(error))}
           // if everything failes, then send to prolific
           SendToProlific()
       }// the whole process is not 100% perfect but will try maximum of 7 or 8 times which means ca 15 seconds and then send back to prolific.
      });
    }

// Function to download data locally (used only for debugging)
function savedata(File2Save,name,jsonfy=true) {
     if (jsonfy){ var File2Save = JSON.stringify(File2Save);}
     var a = document.createElement("a");
     var file = new Blob([File2Save], {type: 'application/json'});
     a.href = URL.createObjectURL(file);
     a.download = name;
     a.click();
     }

// Fill experiment timeline with parts of experiment
timeline.push(info_and_consent)
timeline.push(attention_check)
timeline.push(fullscreen) // browser check + enter full screen
timeline.push(training)
//timeline.push(fullscreen, initial_check) // browser check + enter full screen
//timeline.push(experiment_r1)
timeline.push(halftime)
//timeline.push(experiment_r2)


// Run experiment
jsPsych.init({
  timeline: timeline,
  override_safe_mode: true,
  preload_images: stimuli,
  on_finish: function(){
   completion_code = 'EXPERIMENT_FINISHED'
   senddataNend()
   SendToProlific()
 },
 on_interaction_data_update: function(data) { //if participant exits fullscreen
      if (data.event == 'fullscreenexit' && should_be_in_fullscreen) {
        console.log('exited fullscreen');
        console.log(jsPsych.getDisplayElement())
        jsPsych.getDisplayElement().style.visibility = 'hidden'; // hide the contents of the current trial
        jsPsych.pauseExperiment()
        // add a div that contains a message and button to re-enter fullscreen
        jsPsych.getDisplayElement().insertAdjacentHTML('beforebegin',
          '<div id="message-div" style="margin: auto;top: 50%; left: 50%; margin-right: -50%; text-align: center;">' +
          '<p>Please remain in fullscreen mode during the task.</p>' +
          '<p>When you click the button below, you will enter fullscreen mode.</p>' +
          '<button id="jspsych-fullscreen-btn" class="jspsych-btn">Continue</button>' +
          '<button id="jspsych-end_everything" class="jspsych-btn">Leave task</button></div>');
        // call the request fullscreen function when the button is clicked
        document.querySelector('#jspsych-fullscreen-btn').addEventListener('click', function () {
          var element = document.documentElement;
          if (element.requestFullscreen) {
            element.requestFullscreen();
          } else if (element.mozRequestFullScreen) {
            element.mozRequestFullScreen();
          } else if (element.webkitRequestFullscreen) {
            element.webkitRequestFullscreen();
          } else if (element.msRequestFullscreen) {
            element.msRequestFullscreen();
          }
        });
        document.querySelector('#jspsych-end_everything').addEventListener('click', function () {
          completion_code = 'INTENTIONALLY_ENDED'
          console.log(completion_code)
          document.getElementById("message-div").innerHTML = "Experiment ended.";
          //var data = jsPsych.data.get().localSave('csv', 'data.csv') //save data up to this point

          // PREPARE DATA FOR SAVING
          //var jsdata = jsPsych.data.get().json();
          //const outdata = {partial: false, subid: "sub" + subject_id.toString(), data: jsdata} //, structure according to ARC
          //postData(JSON.stringify(outdata));
          senddataNend()
          //location.replace("https://app.prolific.co/submissions/complete?cc="+completion_code);

        });
      }
      if (data.event == 'fullscreenenter') {
        console.log('entered fullscreen');
        // when entering fullscreen, check to see if the participant is re-entering fullscreen,
        // i.e. the 'please enter fullscreen' message is on the page
        var msg_div = document.querySelector('#message-div');
        if (msg_div !== null) {
          // remove the message
          msg_div.remove();
          // show the contents of the current trial again
          jsPsych.getDisplayElement().style.visibility = 'visible';
          jsPsych.resumeExperiment()
        }
      }
    },
  on_close: function() { // send data if window is closed before end
    var data = jsPsych.data.get().json();
    //postData(ids_json)
    // PREPARE DATA FOR SAVING
    //var jsdata = jsPsych.data.get().json();
    //const outdata = {partial: false, subid: subject_id.toString(), data: jsdata}
    //postData(JSON.stringify(outdata));
    completion_code = 'EXPERIMENT_CLOSED'
    senddataNend()

  }
  //on_finish: function(){jsPsych.data.displayData()}
  // on_finish: function(){
  //   full_data = jsPsych.data.get().json()
  //   file_name = 'pedlr_data_'+participant_id
  //   savedata(full_data, file_name, false)
  // }
});

</script>

</html>
