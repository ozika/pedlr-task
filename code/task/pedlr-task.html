<!DOCTYPE html>
<html>

<head>
  <title>pedlr-task</title>
  <script src="jspsych-6.2.0/jspsych.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-instructions.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-html-slider-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-image-keyboard-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-fullscreen.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-canvas-slider-response.js"></script>
  <script src="jspsych-6.2.0/plugins/jspsych-call-function.js"></script>
  <script src="bowser/bowser.js"></script>

  <script type="text/javascript" src="designs/designs.js" type="application/json"></script>

  <script src="take_a_break.js"></script>
  <script src="fixation.js"></script>
  <script src="feedback.js"></script>
  <script src="free.js"></script>
  <script src="forced.js"></script>
  <script src="estimation.js"></script>
  <script src="if_nodes.js"></script>
  <script src="training.js"></script>

  <link href="jspsych-6.2.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
</head>

<body style="background-color:#000000; color:white">
</body>

<script>

//preload stimuli files
// Get folder contents of stimuli puctures
var stimuli = ['stimuli/a1.png',
               'stimuli/a1.png',
               'stimuli/a1_forced.png',
               'stimuli/a2.png',
               'stimuli/a2_forced.png',
               'stimuli/a3.png',
               'stimuli/a3_forced.png',
               'stimuli/s1.png',
               'stimuli/s1_forced.png',
               'stimuli/s2.png',
               'stimuli/s2_forced.png',
               'stimuli/s3.png',
               'stimuli/s3_forced.png',
               'stimuli/s4.png',
               'stimuli/s4_forced.png',
               'stimuli/s5.png',
               'stimuli/s5_forced.png',
               'stimuli/s6.png',
               'stimuli/s6_forced.png',
               'stimuli/fixation.png'
             ]

// Create list of all designs (separate for each run)
var all_designs_r1 = [
  design_01_run_1, design_02_run_1, design_03_run_1, design_04_run_1,
  design_05_run_1, design_06_run_1, design_07_run_1, design_08_run_1,
  design_09_run_1, design_10_run_1, design_11_run_1, design_12_run_1,
  design_13_run_1, design_14_run_1, design_15_run_1, design_16_run_1,
  design_17_run_1, design_18_run_1, design_19_run_1, design_20_run_1
]

var all_designs_r2 = [
  design_01_run_2, design_02_run_2, design_03_run_2, design_04_run_2,
  design_05_run_2, design_06_run_2, design_07_run_2, design_08_run_2,
  design_09_run_2, design_10_run_2, design_11_run_2, design_12_run_2,
  design_13_run_2, design_14_run_2, design_15_run_2, design_16_run_2,
  design_17_run_2, design_18_run_2, design_19_run_2, design_20_run_2
]

// Get names of designs to save as variable
var names_designs_r1 = [
  'design_01_run_1', 'design_02_run_1', 'design_03_run_1', 'design_04_run_1',
  'design_05_run_1', 'design_06_run_1', 'design_07_run_1', 'design_08_run_1',
  'design_09_run_1', 'design_10_run_1', 'design_11_run_1', 'design_12_run_1',
  'design_13_run_1', 'design_14_run_1', 'design_15_run_1', 'design_16_run_1',
  'design_17_run_1', 'design_18_run_1', 'design_19_run_1', 'design_20_run_1'
]
var names_designs_r2 = [
  'design_01_run_2', 'design_02_run_2', 'design_03_run_2', 'design_04_run_2',
  'design_05_run_2', 'design_06_run_2', 'design_07_run_2', 'design_08_run_2',
  'design_09_run_2', 'design_10_run_2', 'design_11_run_2', 'design_12_run_2',
  'design_13_run_2', 'design_14_run_2', 'design_15_run_2', 'design_16_run_2',
  'design_17_run_2', 'design_18_run_2', 'design_19_run_2', 'design_20_run_2'
]

// Sample design and take both runs from same design
var n_designs = all_designs_r1.length;
var sample = Math.floor(Math.random() * n_designs);
// Set designs for this participant
var design_r1 = all_designs_r1[sample]
var design_r2 = all_designs_r2[sample]
// Save names of designs
var name_design_r1 = names_designs_r1[sample]
var name_design_r2 = names_designs_r2[sample]

// Set scaling of images and margins to adjust size of experiment (in percentage)
var img_scale = 30

// Add stable variables to data
jsPsych.data.addProperties({
      name_design_r1: name_design_r1,
      name_design_r2: name_design_r2,
      browser_name: bowser.name,
      browser_version: bowser.version,
      os_name: bowser.osname,
      os_version: bowser.osversion,
      screen_resolution: screen.width + ' x ' + screen.height,
      window_resolution: window.innerWidth + ' x ' + window.innerHeight
    });

var timeline = []

// Experiment run 1 procedure
var experiment_r1 = {
  timeline: [if_free, if_forced, if_estimation, if_break],
  //timeline_variables: design_r1
  timeline_variables: [
    {type: 'free', stimulus_left: 'stimuli/s2.png', stimulus_right: 'stimuli/s3.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s2_forced.png', stimulus_right: 'stimuli/s3.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s1.png'},
    {type: 'break', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'free', stimulus_left: 'stimuli/s2.png', stimulus_right: 'stimuli/s3.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s2_forced.png', stimulus_right: 'stimuli/s3.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s1.png'}
  ]
}

// Experiment run 2 procedure
var experiment_r2 = {
  timeline: [if_free, if_forced, if_estimation, if_break],
  //timeline_variables: design_r2
  timeline_variables: [
    {type: 'free', stimulus_left: 'stimuli/s5.png', stimulus_right: 'stimuli/s6.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s5_forced.png', stimulus_right: 'stimuli/s6.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s4.png'},
    {type: 'break', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'free', stimulus_left: 'stimuli/s5.png', stimulus_right: 'stimuli/s6.png', outcome_left: 94, outcome_right: 26, forced: 'n/a', stimulus_estimation: 'n/a'},
    {type: 'forced', stimulus_left: 'stimuli/s5_forced.png', stimulus_right: 'stimuli/s6.png', outcome_left: 12, outcome_right: 44, forced: 'left', stimulus_estimation: 'n/a'},
    {type: 'estimation', stimulus_left: 'n/a', stimulus_right: 'n/a', outcome_left: 'n/a', outcome_right: 'n/a', forced: 'n/a', stimulus_estimation: 'stimuli/s4.png'}
  ]
}

var halftime = {
  timeline: [
    {
      type: 'html-keyboard-response',
      stimulus: function(){
        var html = "<p>Halftime!<br></p>"
        html += "<p>You are done with the first part of the task.</p>"
        html += "<p>You've earned yourself a short break!<br></p>"
        html += "<img src='stimuli/break.png'; style='width: " + 300/100 * img_scale+"px'>"
        html += "<p><br>We will now change the available three options which also give different amounts of points.</p>"
        html += "<p>The task works exactly the same, also for the new three options!</p>"
        html += "<p><br><br>Press 'f' or 'j' to continue with the task if you are ready.</p>"
        return html
      },
      choices: ['f', 'j']
    }
  ]
}

// Fill timeline with parts of experiment
timeline.push(training)
timeline.push(experiment_r1)
timeline.push(halftime)
timeline.push(experiment_r2)

// function to save data
function saveData(name, data){
  var xhr = new XMLHttpRequest();
  xhr.open('POST', 'write_data.php'); // 'write_data.php' is the path to the php file described above.
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify({filename: name, filedata: data}));
}

// Run experiment
jsPsych.init({
  timeline: timeline,
  override_safe_mode: true,
  preload_images: stimuli,
  // Save data to file
  //on_finish: function(){ saveData("experiment_data", jsPsych.data.get().csv()); }
  on_finish: function(){jsPsych.data.displayData(); }
});

</script>

</html>
